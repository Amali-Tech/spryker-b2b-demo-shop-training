{% extends view('company-business-unit-address', '@SprykerShop:CompanyWidget') %}

{% block body %}
    {% set defaultAddressKey = null %}
    {% set optionValueDeliverToMultipleAddresses = '-1' %}
    {% set fullAddresses = data.customerAddresses ?: data.companyBusinessUnitAddresses %}
    {% set shippingAddress = 'shippingAddress' %}
    {% set billingAddress = 'billingAddress' %}

    {% if fullAddresses %}
        {% for address in fullAddresses %}
            {% set isShippingAddress = not data.currentAddressId and data.formType == shippingAddress and address.isDefaultShipping %}
            {% set isBillingAddress = not data.currentAddressId and data.formType == billingAddress and address.isDefaultBilling %}
            {% set isCustomerAddress = data.currentAddressId == address.idCustomerAddress %}

            {% if isShippingAddress or isBillingAddress or isCustomerAddress %}
                {% set defaultAddressKey = address.key %}
            {% endif %}

            {% if data.currentAddressId == optionValueDeliverToMultipleAddresses %}
                {% set defaultAddressKey = optionValueDeliverToMultipleAddresses %}
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if data.formType == shippingAddress %}
        <label class="label">{{ 'page.checkout.address.delivery.address_select' | trans }}</label>
    {% endif %}

    {% if data.formType == billingAddress %}
        <label class="label">{{ 'page.checkout.address.billing.address_select' | trans }}</label>
    {% endif %}

    {% embed molecule('custom-select') with {
        modifiers: ['full-width', 'group'],
        class: 'spacing-bottom',
        attributes: {
            name: 'checkout-full-addresses',
            'config-width': '100%',
            'config-theme': 'group',
        },
        data: {
            isGrouped: true,
        },
        embed: {
            customerAddresses: data.customerAddresses,
            companyBusinessUnitAddresses: data.companyBusinessUnitAddresses,
            formType: data.formType,
            defaultAddressKey: defaultAddressKey,
            currentAddressId: data.currentAddressId,
            isMultipleShipmentEnabled: data.isMultipleShipmentEnabled,
            optionValueDeliverToMultipleAddresses: optionValueDeliverToMultipleAddresses,
            itemShippingTriggerJsClass: data.itemShippingTriggerJsClass,
            items: data.items,
            shippingAddress: shippingAddress,
            jsAddressClass: data.jsAddressClass,
        },
    } only %}
        {%- block selectClass -%}
            {{ embed.jsAddressClass }}__form-select-{{ embed.formType }}
            {{ embed.itemShippingTriggerJsClass ? embed.itemShippingTriggerJsClass }}
            {{ parent() }}
        {%- endblock -%}

        {% block option %}
            {% set isSelected = embed.defaultAddressKey == address.key %}
            {% set fullName = '%s %s %s, %s %s, %s %s' | format(
                address.salutation,
                address.firstName,
                address.lastName,
                address.address1,
                address.address2,
                address.zipCode,
                address.city)
            %}
            {% define option = {
                selected: isSelected,
                value: address.key,
                label: fullName
            } %}
            {{ parent() }}
        {% endblock %}

        {% block optionsGroup %}
            <option value="">{{ 'company.account.add_new_address' | trans }}</option>

            {% if embed.customerAddresses %}
                <optgroup label="{{ 'page.checkout.address.option_group.customer' | trans | upper }}">
                    {% for address in embed.customerAddresses %}
                        {{ block('option') }}
                    {% endfor %}
                </optgroup>
            {% endif %}

            {% if embed.companyBusinessUnitAddresses %}
                <optgroup label="{{ 'page.checkout.address.option_group.company_business_unit' | trans | upper }}">
                    {% for address in embed.companyBusinessUnitAddresses %}
                        {{ block('option') }}
                    {% endfor %}
                </optgroup>
            {% endif %}

            {% if embed.formType == embed.shippingAddress and embed.isMultipleShipmentEnabled %}
                <option value="{{ embed.optionValueDeliverToMultipleAddresses }}" {% if embed.defaultAddressKey == embed.optionValueDeliverToMultipleAddresses %}selected{% endif %}>
                    {{ 'customer.account.deliver_to_multiple_addresses' | trans }}
                </option>
            {% endif %}
        {% endblock %}
    {% endembed %}

    {% block addressHandler %}
        {{ parent() }}
    {% endblock %}

    {% block hiddenFields %}
        {{ parent() }}
    {% endblock %}
{% endblock %}
